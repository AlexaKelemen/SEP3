@page "/Checkout"
@using System.ComponentModel
@using System.Security.Claims
@using BlazorApp1.Managers
@using DataTransferObjects
@using Entities
@using Microsoft.AspNetCore.Authorization
@inject AuthenticationStateProvider AuthProvider
@inject IManager Manager
@inject NavigationManager NavigationManager

<PageTitle>Checkout</PageTitle>
<h1>@total.ToString("C", new System.Globalization.CultureInfo("en-DK"))</h1>
<AuthorizeView>
    <Authorized>
        <p>Hello @context.User.Identity.Name</p>
    </Authorized>
</AuthorizeView>
<div class="mb-3">
    <label>First name</label>
    <input type="text" @bind="cardFirstName"/>
</div>

<div class="mb-3">
    <label>Last name</label>
    <input type="text" @bind="cardLastName"/>
</div>

<div class="mb-3">
    <label>Card Number</label>
    <input type="text" @bind="cardNumber"/>
</div>
<div class="mb-3">
    <label>Date</label>
    <InputDate @bind-Value="cardExpirationDate"/>
</div>
<div class="mb-3">
    <label>Cvc</label>
    <input type="text" @bind="cardCvc"/>
</div>
<button type="button" class="btn btn-primary" @onclick="CheckoutItems">Checkout</button>


@code {
    [CascadingParameter] public Task<AuthenticationState> State { get; set; }
    
    private decimal total;
    private string? cardFirstName;
    private string? cardLastName;
    private string? cardCvc;
    private string? cardNumber;
    private DateOnly? cardExpirationDate;

    private User? user;
    
    protected override async Task OnInitializedAsync()
    {
        user = new User();
        total = (decimal)Manager.GetTotal();
        AuthenticationState authenticationState = await State;
        ClaimsPrincipal claimsPrincipal = authenticationState.User;
        if (claimsPrincipal.Identity is null || !claimsPrincipal.Identity.IsAuthenticated)
        {
            // the user is not logged in
            return;
        }
        
        user = await Manager.GetUserAsync(claimsPrincipal.Identity?.Name);
        cardFirstName = user.Card.FName;
        cardLastName = user.Card.LName;
        cardCvc = user.Card.Cvc;
        cardNumber = user.Card.CardNumber;
        cardExpirationDate = user.Card.ExpirationDate;
        
    }

    private async Task<bool> CheckoutItems()
    {
        DeliveryOption deliveryOption = new DeliveryOption()
        {
            Id = 1,
            Name = "To Postal Office",
            OrderId = -1
        };
        Order order = new Order()
        {
            DeliveryOptions = new List<DeliveryOption>()
            {
                new DeliveryOption()
                {
                    Id = 1,
                    Name = "To Postal Office",
                    OrderId = -1
                }
            },
            OrderId = -1,
            PaymentMethod = new PaymentMethod()
            {
                Id = 1,
                Name = "Card"
            },
            PlacedBy = user,
            PlacedOn = DateTime.Now,
            Price = (double)total
        };
        return await Manager.CheckoutAsync(order);
    }
}